name: Build and Release

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get Details
        id: details
        run: |
          version=$(awk '/^[0-9]/ { print $1; exit }' CHANGELOG.md)
          echo "version=v${version}" >> $GITHUB_ENV
          grep -zPo -e "(?s)${version}.*?\n-*?\n\n.*?\n\n" CHANGELOG.md | tail -n +3 >> .release_notes

      - name: Setup Package
        run: |
          TARGET=Assets/SophieBlue/AvatarDresser
          mkdir -p $TARGET
          ls | grep -v "Assets" | xargs -i{} mv {} $TARGET
          .github/workflows/generate_meta.sh bc846a2331c27846b961e0f9fe107d54 > Assets/SophieBlue.meta
          .github/workflows/generate_meta.sh 35463f4647344b07b00095724986cf0a > Assets/SophieBlue/AvatarDresser.meta
          find Assets -type f -name \*.meta >> metaList

      - name: Create Unity Package
        uses: pCYSl5EDgo/create-unitypackage@master
        with:
          package-path: 'AvatarDresser-v${{ env.version }}.unitypackage'
          include-files: metaList

      - name: Create Zipfile
        run: |
          zip -r AvatarDresser-v${{ env.version }}.zip * -x AvatarDresser-v${{ env.version }}.unitypackage

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "AvatarDresser v${{ env.version }}"
          body_path: .release_notes
          files: |
            AvatarDresser-v${{ env.version }}.unitypackage
            AvatarDresser-v${{ env.version }}.zip
