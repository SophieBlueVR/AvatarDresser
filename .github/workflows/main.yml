name: Build and Release

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get Details
        id: details
        run: |
          echo "version=$(awk '/^v[0-9]/ { print $1; exit }' CHANGELOG.md)" >> $GITHUB_ENV
          echo 'details<<EOF' >> $GITHUB_OUTPUT
          grep -zPo -e '(?s)v0.1.0.*?\n-*?\n\n.*?\n\n' CHANGELOG.md | tail -n +3 >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Setup Package
        run: |
          TARGET=Assets/SophieBlue/AvatarDresser
          mkdir -p $TARGET
          ls | grep -v "Assets" | xargs -i{} mv {} $TARGET
          .github/workflows/generate_meta.sh 89ecda3939344c6a833d3e6d55efd3e5 > Assets/SophieBlue.meta
          .github/workflows/generate_meta.sh 35463f4647344b07b00095724986cf0a > Assets/SophieBlue/AvatarDresser.meta
          find Assets -type f -name \*.meta >> metaList

      - name: Create package
        uses: pCYSl5EDgo/create-unitypackage@master
        with:
          package-path: 'AvatarDresser-${{ env.version }}.unitypackage'
          include-files: metaList

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: "AvatarDresser ${{ env.version }}"
          files: |
            AvatarDresser-${{ env.version }}.unitypackage
